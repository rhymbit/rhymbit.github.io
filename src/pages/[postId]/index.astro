---
import DateTimeParsed from "@/components/date-time-parsed/date-time-parsed.astro";
import BaseHeader from "@/headers/base-header.astro";
import BaseLayout from "@/layouts/base-layout.astro";
import type { GetStaticPaths } from "astro";
import { Icon } from "astro-icon/components";
import { getCollection, render } from "astro:content";

export const getStaticPaths = (async () => {
  const allPosts = await getCollection("posts");

  const paths = allPosts.map((post, index) => {
    const prevPost =
      index > 0 ? allPosts[index - 1] : allPosts[allPosts.length - 1];
    const nextPost =
      index < allPosts.length - 1 ? allPosts[index + 1] : allPosts[0];

    return {
      params: {
        postId: post.id,
      },
      props: {
        post: post,
        prevPost: prevPost,
        nextPost: nextPost,
      },
    };
  });

  return paths;
}) satisfies GetStaticPaths;

const { post, prevPost, nextPost } = Astro.props;

const { Content } = await render(post);
---

<BaseLayout class="flex flex-col">
  <BaseHeader
    slot="header"
    title={post.data.title}
    description={post.data.description}
  />
  <main
    class="py-5 lg:py-10 3xl:py-20 px-4 w-full h-full grow flex flex-col items-center overflow-x-clip"
  >
    <!-- Hero -->
    <section class="max-w-4xl flex flex-col items-center gap-y-7">
      <!-- heading, date & description -->
      <div class="flex flex-col items-center gap-y-3 text-center">
        <div class="text-p badge badge-primary">
          <DateTimeParsed date={post.data.pubDate} />
        </div>
        <h1 class="font-bold leading-tight">{post.data.title}</h1>
        <p class="text-h6">{post.data.description}</p>
      </div>
      <!-- tags -->
      <div class="max-w-xl flex-center flex-wrap gap-2">
        {
          post.data.tags &&
            post.data.tags.map((tag) => (
              <span class="badge badge-lg badge-primary gap-x-1">
                <Icon name="tag-rounded" />
                {tag}
              </span>
            ))
        }
      </div>
    </section>

    <div class="mt-3 w-full max-w-6xl">
      <div class="divider h-0.5 bg-amber-300"></div>
    </div>

    <!-- Post Content -->
    <section class="my-10 flex flex-col items-center gap-y-5">
      <div
        class="prose lg:prose-lg xl:prose-xl 3xl:prose-2xl prose-strong:px-2 prose-strong:py-0.5 prose-strong:font-normal prose-strong:bg-primary prose-strong:text-primary-content
          prose-code:text-amber-300"
      >
        <Content />
      </div>
    </section>

    <!-- Prev & Next Posts -->
    <section class="w-full max-w-4xl my-10 flex flex-wrap gap-5 justify-around">
      <div>
        {
          prevPost && (
            <a
              href={`${prevPost.id}`}
              class="h-full card min-w-70 max-w-sm bg-base-300 shadow-sm"
            >
              <div class="card-body flex flex-row justify-around items-center">
                <div class="-rotate-90">
                  <Icon name="middle-finger" class="text-h3" />
                </div>
                <div>
                  <h2 class="card-title text-p">{prevPost.data.title}</h2>
                  <p>{prevPost.data.description}</p>
                </div>
              </div>
            </a>
          )
        }
      </div>
      <div>
        {
          nextPost && (
            <a
              href={`${nextPost.id}`}
              class="h-full card min-w-70 max-w-sm bg-base-300 shadow-sm"
            >
              <div class="card-body flex flex-row justify-around items-center">
                <div>
                  <h2 class="card-title text-p">{nextPost.data.title}</h2>
                  <p>{nextPost.data.description}</p>
                </div>
                <div class="rotate-90">
                  <Icon name="middle-finger" class="text-h3" />
                </div>
              </div>
            </a>
          )
        }
      </div>
    </section>

    <!-- Pagefind fields, used to support search. DO NOT REMOVE. -->
    <section data-pagefind-body class="hidden">
      <span data-pagefind-meta="title">{post.data.title}</span>
      <span data-pagefind-meta="description">{post.data.description}</span>
      {
        post.data.tags && (
          <span data-pagefind-meta="tags">{post.data.tags.join(",")}</span>
        )
      }
    </section>
  </main>
</BaseLayout>
